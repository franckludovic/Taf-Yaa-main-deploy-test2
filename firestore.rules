rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //---------- FUNCTIONS ----------//

    function isSignedIn() {
      return request.auth != null;
    }

    function treeRef(treeId) {
      return get(/databases/$(database)/documents/trees/$(treeId));
    }

    function treeExists(treeId) {
      return exists(/databases/$(database)/documents/trees/$(treeId));
    }

    function isTreeMember(treeId) {
      return isSignedIn()
        && treeExists(treeId)
        && (request.auth.uid in treeRef(treeId).data.memberUIDs ||
            getMemberRole(treeId) != null);
    }

    function isTreePublic(treeId) {
      return treeExists(treeId)
        && treeRef(treeId).data.settings.privacy.isPublic == true;
    }

    function getMemberRole(treeId) {
      let roles = treeRef(treeId).data.roles;
      return roles != null ? roles[request.auth.uid] : null;
    }

    function isTreeAdminOrModerator(treeId) {
      let role = getMemberRole(treeId);
      return role == 'admin' || role == 'moderator';
    }

    function isTreeEditorOrAbove(treeId) {
      let role = getMemberRole(treeId);
      return role == 'admin' || role == 'moderator' || role == 'editor';
    }

    //---------- USERS ----------//

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    //---------- TREES ----------//

		match /trees/{treeId} {
      allow list: if isSignedIn();
      allow get: if isSignedIn() && (
        request.auth.uid in resource.data.memberUIDs ||
        resource.data.settings.privacy.isPublic == true
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isTreeAdminOrModerator(treeId);
	  }

    //---------- PEOPLE ----------//

    match /people/{personId} {
      allow read: if isSignedIn() &&
        (isTreeMember(resource.data.treeId) || isTreePublic(resource.data.treeId));
      allow create: if isSignedIn() && isTreeEditorOrAbove(request.resource.data.treeId);
      allow update, delete: if isSignedIn() &&
        isTreeEditorOrAbove(resource.data.treeId);
      allow list: if isSignedIn();
    }

    //---------- MARRIAGES ----------//

    match /marriages/{marriageId} {
      allow read: if isSignedIn() &&
        (isTreeMember(resource.data.treeId) || isTreePublic(resource.data.treeId));
      allow create: if isSignedIn() && isTreeEditorOrAbove(request.resource.data.treeId);
      allow update, delete: if isSignedIn() &&
        isTreeEditorOrAbove(resource.data.treeId);
      allow list: if isSignedIn();
    }

    //---------- EVENTS ----------//

    match /events/{eventId} {
      allow read: if isSignedIn() &&
        (isTreeMember(resource.data.treeId) || isTreePublic(resource.data.treeId));
      allow create: if isSignedIn() && isTreeEditorOrAbove(request.resource.data.treeId);
      allow update, delete: if isSignedIn() &&
        isTreeEditorOrAbove(resource.data.treeId);
      allow list: if isSignedIn();
    }

    //---------- STORIES ----------//

		match /stories/{storyId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        (resource.data.contributors != null && request.auth.uid in resource.data.contributors) ||
        isTreeMember(resource.data.treeId) ||
        isTreePublic(resource.data.treeId)
      );


      allow create: if isSignedIn() &&
        (request.auth.uid == request.resource.data.createdBy ||
         isTreeEditorOrAbove(request.resource.data.treeId));


      allow update, delete: if isSignedIn() &&
        (request.auth.uid == resource.data.createdBy ||
         isTreeEditorOrAbove(resource.data.treeId));

      allow list: if isSignedIn();
    }

    //---------- MEDIA ----------//

    match /media/{mediaId} {
      allow read: if isSignedIn() &&
        (isTreeMember(resource.data.treeId) || isTreePublic(resource.data.treeId));
      allow create: if isSignedIn() && isTreeEditorOrAbove(request.resource.data.treeId);
      allow update, delete: if isSignedIn() &&
        isTreeEditorOrAbove(resource.data.treeId);
      allow list: if isSignedIn();
    }

    //---------- INVITES ----------//
		match /invites/{inviteId} {
      allow read: if isSignedIn() &&
        (request.auth.uid == resource.data.createdBy ||
         isTreeEditorOrAbove(resource.data.treeId));
      allow create: if isSignedIn() &&
        (request.auth.uid == request.resource.data.createdBy ||
         isTreeEditorOrAbove(request.resource.data.treeId));
      allow update, delete: if isSignedIn() &&
        (request.auth.uid == resource.data.createdBy ||
         isTreeEditorOrAbove(resource.data.treeId));
    }

    //---------- JOIN REQUESTS ----------//

    match /joinRequests/{joinRequestId} {
      // Allow reading a single join request (direct get)
      allow get: if isSignedIn() && (
        isTreeAdminOrModerator(resource.data.treeId) ||
        request.auth.uid == resource.data.submittedBy
      );

      // Allow querying all join requests for a tree
      allow list: if isSignedIn()
        && request.query.where.size() >= 1
        && request.query.where[0][0] == 'treeId'
        && request.query.where[0][1] == '=='
        && (
          isTreeAdminOrModerator(request.query.where[0][2]) ||
          request.auth.uid == treeRef(request.query.where[0][2]).data.createdBy
        );

      // Create join request (any signed-in user)
      allow create: if isSignedIn();

      // Update (approve/reject) only if admin/moderator of the tree
      allow update: if isSignedIn() && isTreeAdminOrModerator(resource.data.treeId);

      // Delete (optional)
      allow delete: if isSignedIn() && isTreeAdminOrModerator(resource.data.treeId);
    }

  } 
}